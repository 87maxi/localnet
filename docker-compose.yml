

services:
  # =============== INICIALIZADOR (se ejecuta una vez) ===============
  # geth-init:
  #   build: ./dc/geth-container
  #   user: "0:0"
  #   environment:
  #      - GETH_JWT_HEX=${GETH_JWT_HEX}
  #      - GETH_PASSWORD=${GETH_PASSWORD}
  #      - NUM_ACCOUNT=${NUM_ACCOUNT}
  #   volumes:
  #     - geth-data:/geth-data:z
  #     - jwt-secret:/jwt-secret:z
  #     - ./volumen/output:/output:z
  #   networks:
  #     - eth-net
  #   restart: "no"
  #   entrypoint: ["/bin/bash", "/app/geth-init.sh"]  

  # keytool:
  #   build: ./dc/keytool
  #   container_name: keytool
  #   environment:
  #     - GETH_WALLET_PASSWORD=${GETH_WALLET_PASSWORD}
  #   depends_on:
  #     geth-init:
  #       condition: service_completed_successfully
  #   volumes:
  #     - geth-data:/geth-data:z
  #     - ./volumen/output:/app/output:z
  #     - ./dc/keytool/config.yaml:/app/config.yaml
  #   command: ["/execute_convert.sh"]
  #   restart: "no"
  #   healthcheck:
  #     test: ["CMD", "test", "-f", "/geth-data/keytool/genesis.ssz"]
  #     interval: 5s
  #     retries: 5

  # =============== CORE BLOCKCHAIN ===============
  geth-daemon:
    build: ./dc/geth-container
    container_name: geth-daemon
    # depends_on:
    #   geth-init:
    #     condition: service_completed_successfully
    environment:
      - NETWORK=sepolia
      - DATADIR=/geth-data/geth
      - JWT_SECRET=/jwt-secret/jwt.hex
      - GENESIS=/geth-data/genesis.json
    ports:
      - "8545:8545"   # HTTP JSON-RPC
      - "8546:8546"   # WebSocket
      - "30303:30303" # P2P
      - "30303:30303/udp"
      - "8551:8551"   # AuthRPC para Lighthouse
    volumes:
      - jwt-secret:/jwt-secret:z
      - geth-data:/geth-data:z
      - ./volumen/output:/output:z
    networks:
      - eth-net
    restart: on-failure
    entrypoint: ["/bin/bash", "/app/geth-sepolia.sh"]
    healthcheck:
      test: ["CMD", "/app/healthcheck-sepolia.sh"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  prysm-beacon:
    image: prysmaticlabs/prysm-beacon-chain:v5.0.4
    container_name: prysm-beacon
    depends_on:
      geth-daemon:
        condition: service_healthy
    command: >
        --sepolia
        --datadir=/prysm-beacon-data
        --execution-endpoint=http://geth-daemon:8551
        --jwt-secret=/jwt-secret/jwt.hex
        --checkpoint-sync-url=https://checkpoint-sync.sepolia.ethpandaops.io
        --verbosity=debug
        --accept-terms-of-use
        --force-clear-db
    ports:
      - "4000:4000"
      - "3500:3500"
      - "12000:12000/udp"
      - "13000:13000"
    volumes:
      - prysm-beacon-data:/prysm-beacon-data:z
      - jwt-secret:/jwt-secret:z
    networks:
      - eth-net

  # =============== blockscout ===============

  # PostgreSQL separado pero simple
  # blockscout-db:
  #   image: postgres:15-alpine
  #   container_name: blockscout-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #     POSTGRES_DB: blockscout
  #   command: >
  #     postgres
  #     -c max_connections=200
  #     -c shared_buffers=256MB
  #     -c effective_cache_size=1GB
  #     -c maintenance_work_mem=64MB
  #     -c checkpoint_completion_target=0.7
  #     -c wal_buffers=16MB
  #     -c default_statistics_target=100
  #   depends_on:
  #       prysm-beacon:
  #         condition: service_healthy
  #   volumes:
  #     - blockscout-data:/var/lib/postgresql/data
  #   ports:
  #     - 5432:5432
  #   networks:
  #     - eth-net
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 10
  #   restart: on-failure



  # Servicio DEDICADO para migraciones
  # blockscout-migrations:
  #   image: blockscout/blockscout:latest
  #   container_name: blockscout-migrations
  #   depends_on:
  #     blockscout-db:
  #       condition: service_healthy
  #   environment:
  #     DATABASE_URL: postgresql://postgres:postgres@blockscout-db:5432/blockscout
  #     ECTO_USE_SSL: "false"
  #     MIX_ENV: prod
  #   command: >
  #     sh -c "
  #       echo 'üïê Waiting for database...' &&
  #       sleep 10 &&
  #       echo 'üöÄ Running Blockscout database migrations...' &&
  #       bin/blockscout eval 'Elixir.Explorer.ReleaseTasks.create_and_migrate()' &&
  #       echo '‚úÖ Migrations completed successfully!' &&
  #       echo 'üéâ Database is ready for Blockscout!'
  #     "
  #   networks:
  #     - eth-net
  #   restart: "no"  # Se ejecuta una vez y termina



  # blockscout-simple:
  #   image: blockscout/blockscout:latest
  #   container_name: blockscout-simple
  #   depends_on:
  #     blockscout-migrations:
  #       condition: service_completed_successfully
  #     geth-daemon:
  #       condition: service_healthy
  #   ports:
  #     - "4040:4000"
  #   environment:
  #       DATABASE_URL: postgresql://postgres:postgres@blockscout-db:5432/blockscout
  #       ECTO_USE_SSL: "false"
  #       POOL_SIZE: "20"
        
  #       # ‚úÖ CONFIGURACI√ìN SEPOLIA
  #       ETHEREUM_JSONRPC_HTTP_URL: "http://geth-daemon:8545"
  #       ETHEREUM_JSONRPC_WS_URL: "ws://geth-daemon:8546"
  #       ETHEREUM_JSONRPC_VARIANT: "geth"
  #       ETHEREUM_JSONRPC_TRANSPORT: "http"
        
  #       # ‚úÖ CONFIGURACI√ìN DE RED SEPOLIA
  #       NETWORK: "Sepolia Testnet"
  #       SUBNETWORK: "Ethereum Testnet"
  #       CHAIN_ID: "11155111"
  #       COIN: "ETH"
  #       SHOW_PRICE: "true"
  #       DISABLE_EXCHANGE_RATES: "false"
        
  #       # Otros configs se mantienen igual...
  #   command: ["bin/blockscout", "start"]
  #   networks:
  #     - eth-net
  #   restart: unless-stopped

  #blockscout-frontend:
  #  build:
  #    context: ./dc/blockscout-frontend
  #  container_name: blockscout-frontend
  #  depends_on:
  #    - blockscout-simple
  #  ports:
  #    - "3000:3000"
  #  networks:
  #    - eth-net
  #  volumes:
  #    - blockscout-frontend:/app
  #  restart: unless-stopped

volumes:
  jwt-secret:
  prysm-genesis:
  prysm-keys:
  geth-data:
  prysm-beacon-data:
  prysm-validator:
  blockscout-data:
  blockscout-frontend:

networks:
  eth-net:
    name: eth-net
    driver: bridge