services:
  # =============== CORE BLOCKCHAIN ===============
  geth-daemon:
    image: ethereum/client-go:latest
    container_name: geth-daemon
    environment:
      - JWT_SECRET=/jwt-secret/jwt.hex
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
      - "30303:30303/udp"
      - "8551:8551"
    volumes:
      - jwt-secret:/jwt-secret:z
      - geth-data:/geth-data:z
      - ./volumen/output:/output:z
      - ./dc/geth-container/scripts:/app:z
    networks:
      - eth-net
    restart: unless-stopped
    entrypoint: ["/bin/sh", "/app/geth-sepolia.sh"]
    healthcheck:
      test: ["CMD", "geth", "attach", "--exec", "eth.blockNumber", "http://localhost:8545"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # =============== LIGHTHOUSE BEACON (REEMPLAZA NIMBUS) ===============
  lighthouse-beacon:
    image: sigp/lighthouse:latest
    container_name: lighthouse-beacon
    depends_on:
      geth-daemon:
        condition: service_healthy
    command: |
      lighthouse
      beacon_node
      --network=sepolia
      --datadir=/lighthouse-data
      --execution-endpoint=http://geth-daemon:8551
      --execution-jwt=/jwt-secret/jwt.hex
      --http
      --http-address=0.0.0.0
      --http-port=3500
      --http-allow-origin=*
      --metrics
      --metrics-address=0.0.0.0
      --metrics-port=8100
      --suggested-fee-recipient=0x5EF85e87e05Dbc7F32d20ec1991b24Fb112f1151
      --checkpoint-sync-url=https://sepolia.checkpoint.sigp.io
      --target-peers=50
      --listen-address=0.0.0.0
      --port=9000
      --discovery-port=9000
      --disable-upnp
    ports:
      - "3500:3500"
      - "8100:8100"
      - "9000:9000/tcp"
      - "9000:9000/udp"
    volumes:
      - lighthouse-data:/lighthouse-data
      - jwt-secret:/jwt-secret:z
    networks:
      - eth-net
    healthcheck:
      test: ["CMD-SHELL", "timeout 10 sh -c '</dev/tcp/127.0.0.1/3500'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
  
  # =============== IPFS ===============  # ‚Üê AGREGAR ESTE SERVICIO QUE FALTABA
  ipfs-node:
    image: ipfs/kubo:latest
    container_name: ipfs-node
    ports:
      - "5001:5001"   # API
      - "8081:8080"   # Gateway
      - "4001:4001"   # Swarm
    volumes:
      - ipfs-data:/data/ipfs
    networks:
      - eth-net
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
  # =============== POSTGRES GRAPH ===============
  postgres-graph:
    image: postgres:15-alpine
    container_name: postgres-graph
    environment:
      POSTGRES_USER: graph-node
      POSTGRES_PASSWORD: let-me-in
      POSTGRES_INITDB_ARGS: "--locale=C --encoding=UTF8"
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    ports:
      - "5433:5432"
    volumes:
      - postgres-graph-data:/var/lib/postgresql/data
      - ./dc/graph-db/scripts/init-database.sql:/docker-entrypoint-initdb.d/init-database.sql
    networks:
      - eth-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U graph-node"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped

  # =============== GRAPH NODE ===============
  graph-node:
    image: graphprotocol/graph-node:latest
    container_name: graph-node
    depends_on:
      postgres-graph:
        condition: service_healthy
      ipfs-node:
        condition: service_healthy
      geth-daemon:
        condition: service_healthy
    environment:
      - postgres_host=postgres-graph
      - postgres_user=graph-node
      - postgres_pass=let-me-in
      - postgres_db=graph-node
      - ipfs=http://ipfs-node:5001
      - ethereum=sepolia:http://geth-daemon:8545
      - ETHEREUM_REORG_THRESHOLD=50
      - RUST_LOG=info
      - GRAPH_LOG=info
      - GRAPH_IGNORE_COLLATION_CHECK=true
    ports:
      - "8000:8000"   # GraphQL HTTP
      - "8020:8020"   # JSON-RPC
      - "8030:8030"   # Subscriptions (WebSocket)
      - "8040:8040"   # Metrics
    volumes:
      - ./volumen/subgraphs:/subgraphs
    networks:
      - eth-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/metrics"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 90s
    restart: unless-stopped

  # =============== POSTGRES PRINCIPAL ===============
  postgres-db:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: blockscout
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - eth-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped

  # =============== BLOCKSCOUT MIGRATIONS ===============
  blockscout-migrations:
    image: blockscout/blockscout:latest
    container_name: blockscout-migrations
    depends_on:
      postgres-db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres-db:5432/blockscout
      ECTO_USE_SSL: "false"
      MIX_ENV: prod
      ETHEREUM_JSONRPC_HTTP_URL: "http://geth-daemon:8545"
      ETHEREUM_JSONRPC_WS_URL: "ws://geth-daemon:8546"
    command: >
      sh -c "
        echo 'üïê Esperando base de datos...' &&
        until nc -z postgres-db 5432; do
          sleep 5
        done &&
        echo 'üöÄ Ejecutando migraciones de Blockscout...' &&
        bin/blockscout eval 'Elixir.Explorer.ReleaseTasks.create_and_migrate()' &&
        echo '‚úÖ Migraciones completadas!' &&
        echo 'üéâ Base de datos lista para Blockscout!'
      "
    networks:
      - eth-net
    restart: "no"

  # =============== BLOCKSCOUT ===============
  blockscout:
    image: blockscout/blockscout:latest
    container_name: blockscout
    depends_on:
      blockscout-migrations:
        condition: service_completed_successfully
    ports:
      - "4000:4000"
    environment:
      # === VARIABLES CR√çTICAS - SIN ESTAS SE CIERRA ===
      ETHEREUM_JSONRPC_HTTP_URL: "http://geth-daemon:8545"
      ETHEREUM_JSONRPC_WS_URL: "ws://geth-daemon:8546"
      ETHEREUM_JSONRPC_VARIANT: "geth"
      DATABASE_URL: "postgresql://postgres:postgres@postgres-db:5432/blockscout"
      NETWORK: "Sepolia"
      CHAIN_ID: "11155111"
      COIN: "ETH"
      
      # === VARIABLES OPCIONALES ===
      SHOW_PRICE: "false"
      LOG_LEVEL: "info"
      MIX_ENV: "prod"
      POOL_SIZE: "10"
      ECTO_USE_SSL: "false"
    networks:
      - eth-net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000 || exit 0"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 120s
    restart: unless-stopped

volumes:
  jwt-secret:
  geth-data:
  lighthouse-data:  # Cambiado de nimbus-data
  ipfs-data:
  postgres-data:
  postgres-graph-data:

networks:
  eth-net:
    driver: bridge